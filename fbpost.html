import React, { useState, useEffect } from 'react';
import { Play, Pause, Plus, Trash2, Settings, Clock, ImageIcon } from 'lucide-react';

export default function FacebookAutoPoster() {
  const [topics, setTopics] = useState([]);
  const [newTopic, setNewTopic] = useState('');
  const [interval, setInterval] = useState(60);
  const [isRunning, setIsRunning] = useState(false);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [pageAccessToken, setPageAccessToken] = useState('');
  const [pageId, setPageId] = useState('');
  const [logs, setLogs] = useState([]);
  const [nextPostTime, setNextPostTime] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [timerId, setTimerId] = useState(null);

  useEffect(() => {
    const saved = localStorage.getItem('fbPosterData');
    if (saved) {
      const data = JSON.parse(saved);
      setTopics(data.topics || []);
      setInterval(data.interval || 60);
      setPageAccessToken(data.token || '');
      setPageId(data.pageId || '');
    }
  }, []);

  useEffect(() => {
    const data = { topics, interval, token: pageAccessToken, pageId };
    localStorage.setItem('fbPosterData', JSON.stringify(data));
  }, [topics, interval, pageAccessToken, pageId]);

  useEffect(() => {
    if (timerId) {
      clearInterval(timerId);
    }

    if (!isRunning) {
      setNextPostTime(null);
      return;
    }

    const next = new Date(Date.now() + interval * 60 * 1000);
    setNextPostTime(next);

    const newTimerId = setInterval(() => {
      postToFacebook();
    }, interval * 60 * 1000);

    setTimerId(newTimerId);

    return () => {
      if (newTimerId) clearInterval(newTimerId);
    };
  }, [isRunning, interval]);

  const addTopic = () => {
    if (newTopic.trim()) {
      setTopics([...topics, newTopic.trim()]);
      setNewTopic('');
    }
  };

  const removeTopic = (index) => {
    setTopics(topics.filter((_, i) => i !== index));
  };

  const addLog = (message, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString();
    setLogs(prev => [{timestamp, message, type}, ...prev].slice(0, 50));
  };

  const searchImageAndText = async (topic) => {
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{
            role: 'user',
            content: `Create an engaging Facebook post about "${topic}". Include:
1. A catchy headline or opening (max 2 sentences)
2. 2-3 interesting facts or insights
3. A call-to-action or question to engage audience
4. Suggest a relevant image search query

Format as JSON:
{
  "text": "the post text",
  "imageQuery": "search query for finding relevant image"
}`
          }],
          tools: [{
            type: "web_search_20250305",
            name: "web_search"
          }]
        })
      });

      const data = await response.json();
      let content = data.content.find(c => c.type === 'text')?.text || '';
      
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0]);
        return result;
      }

      return {
        text: `Check out this interesting topic: ${topic}! üåü\n\nStay tuned for more updates!`,
        imageQuery: topic
      };
    } catch (error) {
      addLog(`Error generating content: ${error.message}`, 'error');
      return {
        text: `Exploring ${topic} today! üåü\n\nWhat are your thoughts?`,
        imageQuery: topic
      };
    }
  };

  const searchImage = async (query) => {
    try {
      const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&client_id=demo`);
      
      if (response.ok) {
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          return data.results[0].urls.regular;
        }
      }
    } catch (error) {
      addLog(`Image search failed: ${error.message}`, 'error');
    }
    
    return `https://via.placeholder.com/1200x630/4267B2/ffffff?text=${encodeURIComponent(query)}`;
  };

  const postToFacebook = async () => {
    if (topics.length === 0) {
      addLog('No topics in list!', 'error');
      setIsRunning(false);
      return;
    }

    if (!pageAccessToken || !pageId) {
      addLog('Please configure Page Access Token and Page ID', 'error');
      setIsRunning(false);
      return;
    }

    const topic = topics[currentIndex];
    addLog(`Processing topic: ${topic}`, 'info');

    try {
      const content = await searchImageAndText(topic);
      addLog('Content generated', 'success');

      const imageUrl = await searchImage(content.imageQuery);
      addLog('Image found', 'success');

      const formData = new FormData();
      formData.append('message', content.text);
      formData.append('url', imageUrl);
      formData.append('access_token', pageAccessToken);

      const response = await fetch(`https://graph.facebook.com/v18.0/${pageId}/photos`, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.id) {
        addLog(`‚úÖ Posted successfully! Post ID: ${result.id}`, 'success');
        setCurrentIndex((currentIndex + 1) % topics.length);
        const next = new Date(Date.now() + interval * 60 * 1000);
        setNextPostTime(next);
      } else {
        addLog(`‚ùå Facebook API Error: ${result.error?.message || 'Unknown error'}`, 'error');
      }
    } catch (error) {
      addLog(`‚ùå Error: ${error.message}`, 'error');
    }
  };

  const toggleScheduler = () => {
    if (!isRunning && topics.length === 0) {
      addLog('Please add topics first!', 'error');
      return;
    }
    if (!isRunning && (!pageAccessToken || !pageId)) {
      addLog('Please configure Facebook credentials', 'error');
      setShowSettings(true);
      return;
    }
    setIsRunning(!isRunning);
    addLog(isRunning ? 'Scheduler stopped' : 'Scheduler started', 'info');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="flex items-center justify-between mb-8">
            <div>
              <h1 className="text-4xl font-bold text-gray-800 mb-2">
                Facebook Auto Poster
              </h1>
              <p className="text-gray-600">Automated content posting with AI-powered generation</p>
            </div>
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="p-3 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
            >
              <Settings className="w-6 h-6 text-gray-700" />
            </button>
          </div>

          {showSettings && (
            <div className="mb-8 p-6 bg-blue-50 rounded-xl border-2 border-blue-200">
              <h3 className="text-xl font-semibold mb-4 text-gray-800">Facebook Configuration</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Page Access Token
                  </label>
                  <input
                    type="password"
                    value={pageAccessToken}
                    onChange={(e) => setPageAccessToken(e.target.value)}
                    className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="Enter your Page Access Token"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Get this from Facebook Developer Console ‚Üí Your App ‚Üí Graph API Explorer
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Facebook Page ID
                  </label>
                  <input
                    type="text"
                    value={pageId}
                    onChange={(e) => setPageId(e.target.value)}
                    className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                    placeholder="Enter your Page ID"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Find this in your Facebook Page settings or Graph API Explorer
                  </p>
                </div>
              </div>
            </div>
          )}

          <div className="grid md:grid-cols-2 gap-6 mb-8">
            <div className="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm opacity-90">Posting Interval</span>
                <Clock className="w-5 h-5" />
              </div>
              <div className="flex items-baseline gap-2">
                <input
                  type="number"
                  value={interval}
                  onChange={(e) => setInterval(Math.max(1, parseInt(e.target.value) || 1))}
                  className="w-24 bg-white/20 backdrop-blur text-white text-3xl font-bold rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/50"
                  disabled={isRunning}
                />
                <span className="text-2xl font-semibold">minutes</span>
              </div>
            </div>

            <div className="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm opacity-90">Status</span>
                <div className={`w-3 h-3 rounded-full ${isRunning ? 'bg-white animate-pulse' : 'bg-white/50'}`} />
              </div>
              <div className="text-3xl font-bold mb-1">
                {isRunning ? 'Running' : 'Stopped'}
              </div>
              {nextPostTime && isRunning && (
                <div className="text-sm opacity-90">
                  Next post: {nextPostTime.toLocaleTimeString()}
                </div>
              )}
            </div>
          </div>

          <div className="mb-6">
            <h3 className="text-xl font-semibold mb-4 text-gray-800">Topics List ({topics.length})</h3>
            <div className="flex gap-2 mb-4">
              <input
                type="text"
                value={newTopic}
                onChange={(e) => setNewTopic(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && addTopic()}
                className="flex-1 p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                placeholder="Enter a topic (e.g., 'AI Technology', 'Healthy Recipes')"
              />
              <button
                onClick={addTopic}
                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
              >
                <Plus className="w-5 h-5" />
                Add
              </button>
            </div>

            <div className="space-y-2 max-h-64 overflow-y-auto">
              {topics.map((topic, index) => (
                <div
                  key={index}
                  className={`p-4 rounded-lg border-2 transition flex items-center justify-between ${
                    index === currentIndex && isRunning
                      ? 'bg-blue-50 border-blue-300'
                      : 'bg-gray-50 border-gray-200'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <span className="text-sm font-semibold text-gray-500">#{index + 1}</span>
                    <span className="font-medium text-gray-800">{topic}</span>
                    {index === currentIndex && isRunning && (
                      <span className="px-2 py-1 bg-blue-600 text-white text-xs rounded-full">
                        Current
                      </span>
                    )}
                  </div>
                  <button
                    onClick={() => removeTopic(index)}
                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"
                    disabled={isRunning}
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              ))}
              {topics.length === 0 && (
                <div className="text-center py-12 text-gray-400">
                  <ImageIcon className="w-16 h-16 mx-auto mb-3 opacity-50" />
                  <p>No topics yet. Add some topics to get started!</p>
                </div>
              )}
            </div>
          </div>

          <div className="flex gap-4">
            <button
              onClick={toggleScheduler}
              className={`flex-1 py-4 rounded-xl font-semibold text-white transition transform hover:scale-105 flex items-center justify-center gap-3 ${
                isRunning
                  ? 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700'
                  : 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700'
              }`}
              disabled={topics.length === 0}
            >
              {isRunning ? (
                <>
                  <Pause className="w-6 h-6" />
                  Stop Scheduler
                </>
              ) : (
                <>
                  <Play className="w-6 h-6" />
                  Start Scheduler
                </>
              )}
            </button>
            <button
              onClick={postToFacebook}
              className="px-8 py-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl font-semibold hover:from-indigo-600 hover:to-indigo-700 transition transform hover:scale-105"
              disabled={topics.length === 0 || !pageAccessToken || !pageId}
            >
              Post Now
            </button>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-8">
          <h3 className="text-xl font-semibold mb-4 text-gray-800">Activity Log</h3>
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {logs.map((log, index) => (
              <div
                key={index}
                className={`p-3 rounded-lg text-sm font-mono ${
                  log.type === 'error'
                    ? 'bg-red-50 text-red-700'
                    : log.type === 'success'
                    ? 'bg-green-50 text-green-700'
                    : 'bg-gray-50 text-gray-700'
                }`}
              >
                <span className="opacity-70">[{log.timestamp}]</span> {log.message}
              </div>
            ))}
            {logs.length === 0 && (
              <div className="text-center py-12 text-gray-400">
                <p>No activity yet. Start the scheduler to see logs here.</p>
              </div>
            )}
          </div>
        </div>

        <div className="mt-6 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
          <h4 className="font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Setup Instructions</h4>
          <ol className="text-sm text-yellow-800 space-y-2 list-decimal list-inside">
            <li>Go to <a href="https://developers.facebook.com" target="_blank" className="underline">Facebook Developer Console</a></li>
            <li>Create a new App (Business type) and add "Facebook Login" and "Pages" products</li>
            <li>Use Graph API Explorer to get a Page Access Token with permissions: pages_show_list, pages_read_engagement, pages_manage_posts</li>
            <li>Get your Page ID from your Facebook Page settings</li>
            <li>Paste both values in the settings above</li>
            <li>Add topics and set your posting interval</li>
            <li>Click "Start Scheduler" to begin automated posting</li>
          </ol>
        </div>
      </div>
    </div>
  );
}